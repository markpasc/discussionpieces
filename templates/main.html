{% extends "base.html" %}

{% block title %}hi{% endblock %}
{% block content_header %}hi{% endblock %}
{% block content %}

    <div id="sky"></div>
    <canvas id="sky-bg" width="1000" height="1000"></canvas>
    <div id="ground"></div>
    
    <div id="cloud">
        <h1 id="cloud-title"></h1>
        <div>
            <img width="32" height="32" src="/assets/1.gif" id="cloud-icon">
            <span id="cloud-desc"></span>
        </div>
    </div>
    
    <script type="text/javascript">
    function clickerFor (item) {
        return function (e) {
            //alert('omg hi from ' + item.key);
            // Load piece's data into display bubble.
            $('#cloud-title').text(item.name);
            $('#cloud-desc').text(item.desc);
            $('#cloud-icon').attr('src', '/assets/icons/' + item.icon);
            $('#cloud').css('left', item.x + 'px');
            $('#cloud').css('top', (item.y - 140) + 'px')
            $('#cloud').show('clip', {}, 200);
        };
    }
    
    function drawSky () {
        var sky = $('#sky');
        var canvas = $('#sky-bg');
        var c = canvas.get(0).getContext('2d');
        
        c.fillStyle = 'rgb(200, 0, 0)'
        c.fillRect(0, 0, 1000, 1000);
        
        c.fillStyle = 'red';
        c.save();
        c.translate(500, 500);

        c.moveTo(0, 0);
        for (var θ = 0; θ < 360; θ += 20) {
            c.save();
            
            c.rotate(θ * Math.PI / 180);
            c.lineTo(710, 0);
            
            c.rotate(10 * Math.PI / 180);
            c.lineTo(710, 0);
            
            c.lineTo(0, 0);
            c.fill();

            c.restore();
        }
        
        var grad = c.createRadialGradient(0, 0, 20, 0, 0, 500);
        grad.addColorStop(0, 'rgba(0, 0, 0, 0.03)');
        grad.addColorStop(1, 'rgba(0, 0, 0, 0.6)');
        c.fillStyle = grad;
        c.fillRect(-500, -500, 1000, 1000);
        
        c.restore();
    }
    
    function setUpStuff () {
        $.getJSON("/stuff", function (data) {
            $.each(data, function (i, item) {
                var div = $("<div/>")
                    .attr("class", "piece")
                    .attr("id", "piece-" + item.key)
                    .appendTo('#ground');
                var img = $("<img/>")
                    .attr("src", "/assets/icons/" + item.icon)
                    .appendTo(div);
                div.css('left', item.x);
                div.css('top',  item.y);
                div.draggable({
                    'containment': '#ground',
                    'stop': function (e) {
                        item.x = parseInt(div.css('left'));
                        item.y = parseInt(div.css('top'));
                        $.post("/stuff/" + item.key,
                            {'x': item.x, 'y': item.y}
                        );
                    }
                });
                div.click(clickerFor(item));
            });
        });
    }

    $(document).ready(function () {
        drawSky();
        setUpStuff();
    });
    </script>

{% endblock %}
